# 修复评估报告中英文智能切换问题

经过分析，目前逻辑中存在一个潜在问题：`EvaluationContext` 中的 `startEvaluation` 方法虽然接收了 `payload`，但在将其传递给 `useObject` 的 `submit` 方法时，可能没有正确地将 `language` 字段包含在内，或者在后端处理时 Schema 的强制性可能覆盖了 Prompt 的语言指令。

为了确保中英文智能切换生效，我们将执行以下计划：

## 1. 验证并修复前端参数传递
- **检查 `src/lib/context/evaluation-context.tsx`**: 
  - 确认 `startEvaluation` 方法是否正确地将 `language` 字段透传给了 `submit` 函数。
  - 目前代码中我们已经做了修改，但需要再次确认 `submit` 调用时是否显式解构并包含了 `language`。

## 2. 增强后端 API 的语言控制 (`src/app/api/evaluate/route.ts`)
- **调整 Prompt 策略**: 
  - 目前的指令是追加在 `baseSystemPrompt` 之后。为了加强 AI 的遵从性，我们将把语言指令移动到 `finalSystemPrompt` 的**最末尾**，紧跟在 Rubric 之后，确保它是 AI 看到的最后一条系统指令。
  - **增强指令强度**: 修改指令措辞，明确要求 JSON 字段中的字符串值（String Values）必须翻译成中文。
  - **代码修改**:
    ```typescript
    // 原逻辑
    if (body.language === 'zh') {
      baseSystemPrompt += ... // 追加在中间
    }
    
    // 新逻辑建议
    let languageInstruction = "";
    if (body.language === 'zh') {
      languageInstruction = `\n\nOUTPUT INSTRUCTIONS:\n1. All feedback content, critiques, reasons, and suggestions MUST be in Simplified Chinese (简体中文).\n2. Keep strictly to the JSON schema structure.\n3. Retain English for specific IELTS terms (e.g., "Task Response", "Coherence & Cohesion").`;
    }
    
    const finalSystemPrompt = `${baseSystemPrompt}\n\n[Specific Rubric...]\n${selectedRubric}${languageInstruction}`;
    ```

## 3. 验证 Schema 定义 (`src/lib/schemas/evaluation.ts`)
- 虽然不需要修改 Schema 结构，但我们需要确认 Schema 的 `description` 字段没有强制指定“使用英文”。如果 Schema 中有类似 "Reason in English" 的描述，需要将其移除或修改为中性描述（如 "Reason for the score"）。

## 执行步骤
1.  修改 `src/app/api/evaluate/route.ts`，优化语言指令的插入位置和强度。
2.  检查 `src/lib/schemas/evaluation.ts`，确保没有冲突的语言限制描述。
3.  无需再次修改前端，因为之前的 `Workshop` 和 `Context` 修改已正确传递了参数。